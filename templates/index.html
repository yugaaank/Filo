<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Commander</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #FAFAFA;
            --sidebar-bg: #FFFFFF;
            --glass-border: rgba(0, 0, 0, 0.05);
            --text: #000000;
            --dim: #888888;
            --hover: rgba(0, 0, 0, 0.02);
            --folder-color: #FFCC00;
            --glass-front: rgba(255, 255, 255, 0.1);
            --border-highlight: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] {
            --bg: #000000;
            --sidebar-bg: #0A0A0A;
            --glass-border: rgba(255, 255, 255, 0.05);
            --text: #FFFFFF;
            --dim: #666666;
            --hover: rgba(255, 255, 255, 0.05);
            --glass-front: rgba(255, 255, 255, 0.05);
            --border-highlight: rgba(255, 255, 255, 0.12);
        }

        * { box-sizing: border-box; font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, sans-serif; transition: background 0.3s, color 0.3s, transform 0.2s; }
        
        body { margin: 0; height: 100vh; background: var(--bg); color: var(--text); display: flex; overflow: hidden; padding: 20px; }

        .sidebar { width: 240px; background: var(--sidebar-bg); border: 1px solid var(--glass-border); border-radius: 24px; display: flex; flex-direction: column; padding: 64px 12px 32px; flex-shrink: 0; margin-right: 20px; backdrop-filter: blur(40px); }
        .window-controls { position: absolute; top: 40px; left: 40px; display: flex; gap: 8px; z-index: 100; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .red { background: #FF5F57; } .yellow { background: #FEBC2E; } .green { background: #28C840; }

        .sidebar-section { margin-bottom: 40px; }
        .sidebar-title { font-size: 10px; font-weight: 700; color: var(--dim); padding: 0 20px; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1.5px; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; text-decoration: none; color: var(--text); font-size: 13px; border-radius: 12px; cursor: pointer; font-weight: 500; }
        .sidebar-item:hover { background: var(--hover); }
        .sidebar-item.active { background: var(--hover); font-weight: 600; border-left: 2px solid var(--folder-color); }

        .disk-usage { padding: 20px; font-size: 12px; color: var(--dim); margin-top: auto; }
        .progress-bg { height: 6px; background: var(--hover); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--folder-color); border-radius: 3px; }

        .explorer { flex: 1; display: flex; flex-direction: column; background: var(--sidebar-bg); border: 1px solid var(--glass-border); border-radius: 24px; overflow: hidden; position: relative; backdrop-filter: blur(40px); }
        .top-bar { height: 72px; display: flex; align-items: center; padding: 0 40px; gap: 24px; border-bottom: 1px solid var(--glass-border); }
        .breadcrumb-bar { padding: 12px 40px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--dim); font-weight: 500; min-height: 44px; overflow-x: auto; scrollbar-width: none; }
        .breadcrumb-bar::-webkit-scrollbar { display: none; }
        .breadcrumb-bar span { cursor: pointer; white-space: nowrap; }
        .breadcrumb-bar span:hover { color: var(--text); text-decoration: underline; }

        .pane-body { flex: 1; overflow-y: auto; padding: 32px; }

        .body-grid { display: grid; grid-template-columns: repeat(auto-fill, 110px); gap: 56px; justify-content: start; align-content: start; }
        .body-list { display: flex; flex-direction: column; gap: 4px; }

        .folder-card, .file-card { width: 110px; height: 95px; position: relative; cursor: pointer; display: flex; align-items: flex-end; transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1); }
        .folder-card:hover, .file-card:hover { transform: translateY(-4px); }
        
        .trash-entry {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .trash-entry .f-front {
            border-color: rgba(255, 255, 255, 0.2);
        }
        .trash-entry .f-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trash-entry .f-meta {
            color: var(--folder-color);
        }
        .trash-entry.entry-list {
            border-left: 2px dashed var(--folder-color);
        }

        .f-back { position: absolute; top: 15%; left: 0; width: 100%; height: 85%; background: var(--folder-color); border-radius: 10px; z-index: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .f-tab { position: absolute; top: 0; left: 0; width: 45%; height: 25%; background: var(--folder-color); border-top-left-radius: 6px; border-top-right-radius: 6px; z-index: 1; }
        .f-front { position: relative; width: 100%; height: 75%; background: var(--glass-front); backdrop-filter: blur(20px) saturate(150%); border: 1px solid var(--border-highlight); border-radius: 10px; z-index: 2; display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; box-shadow: 0 -4px 20px rgba(0,0,0,0.3), 0 6px 20px rgba(0,0,0,0.2); }
        
        .fi-back { position: absolute; top: 5%; left: 15%; width: 70%; height: 95%; background: #E5E5E5; border-radius: 8px; z-index: 1; border: 1px solid rgba(0,0,0,0.05); }
        [data-theme="dark"] .fi-back { background: #1A1A1A; border-color: rgba(255,255,255,0.05); }
        .fi-front { position: relative; width: 100%; height: 80%; background: var(--glass-front); backdrop-filter: blur(15px); border: 1px solid var(--border-highlight); border-radius: 10px; z-index: 2; display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        
        .f-name { font-size: 10px; font-weight: 800; color: #FFFFFF; margin-bottom: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .file-card .f-name { color: var(--text); text-shadow: none; }
        .f-meta { font-size: 7px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }
        .file-card .f-meta { color: var(--dim); }

        /* Multi-select Styles */
        .select-checkbox {
            position: absolute;
            top: 6px;
            left: 6px;
            z-index: 10;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--folder-color);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .folder-card:hover .select-checkbox, 
        .file-card:hover .select-checkbox,
        .entry-list:hover .select-checkbox,
        .select-checkbox:checked {
            opacity: 1;
        }

        .selected-item {
            outline: 2px solid var(--folder-color) !important;
            background: var(--hover) !important;
        }

        .batch-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            display: none;
            gap: 20px;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .batch-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: transform 0.1s;
        }

        .batch-btn:active { transform: scale(0.95); }

        .entry-list { display: flex; align-items: center; gap: 16px; padding: 10px 16px; font-size: 14px; cursor: pointer; border-radius: 10px; color: var(--text); text-decoration: none; border-bottom: 1px solid var(--glass-border); position: relative; }
        .entry-list:hover { background: var(--hover); }
        .entry-list .select-checkbox { top: 50%; transform: translateY(-50%); left: 4px; }

        .action-bar { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--sidebar-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 12px 32px; border-radius: 24px; display: flex; gap: 32px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 200; }
        .tool-btn { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; cursor: pointer; letter-spacing: 0.5px; opacity: 0.7; text-transform: uppercase; color: var(--text); }
        .tool-btn:hover { opacity: 1; color: var(--folder-color); }

        .btn-toggle { padding: 8px 16px; border-radius: 14px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid var(--glass-border); background: rgba(255, 255, 255, 0.05); color: var(--dim); display: flex; align-items: center; gap: 8px; }
        .btn-toggle.active { background: var(--text); color: var(--bg); border-color: var(--text); }

        .select-input { background: transparent; border: 1px solid var(--glass-border); color: var(--text); font-size: 11px; font-weight: 700; padding: 6px 12px; border-radius: 10px; outline: none; }

        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(50px); z-index: 1000; align-items: center; justify-content: center; }
        .overlay-content { width: 90%; height: 90%; background: var(--bg); border-radius: 32px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; overflow: hidden; }

        .context-menu { position: fixed; background: var(--sidebar-bg); border: 1px solid var(--glass-border); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); padding: 8px; z-index: 2000; display: none; min-width: 200px; backdrop-filter: blur(30px) saturate(150%); }
        .context-menu-item { padding: 10px 14px; font-size: 13px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 12px; color: var(--text); font-weight: 500; }
        .context-menu-item:hover { background: var(--hover); }
        .context-menu-item i { opacity: 0.6; }
        .context-menu-separator { height: 1px; background: var(--glass-border); margin: 6px 4px; }
    </style>
</head>
<body data-theme="dark">
    <div id="context-menu" class="context-menu"></div>
    <div class="window-controls">
        <div class="dot red" onclick="location.href='/'"></div>
        <div class="dot yellow" onclick="toggleTheme()"></div>
        <div class="dot green" onclick="toggleFullscreen()"></div>
    </div>

    <div class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Personal</div>
            <div class="sidebar-item active" onclick="loadPane('{{ home_path }}')"><i data-lucide="home" size="16"></i> Home</div>
            <div class="sidebar-item" onclick="loadPane('{{ home_path }}/Desktop')"><i data-lucide="monitor" size="16"></i> Desktop</div>
            <div class="sidebar-item" onclick="loadPane('{{ home_path }}/Documents')"><i data-lucide="file-text" size="16"></i> Documents</div>
            <div class="sidebar-item" onclick="loadPane('{{ home_path }}/Downloads')"><i data-lucide="download" size="16"></i> Downloads</div>
            <div class="sidebar-item" onclick="loadPane('{{ home_path }}/Pictures')"><i data-lucide="image" size="16"></i> Images</div>
            <div class="sidebar-item" onclick="loadPane('{{ home_path }}/Videos')"><i data-lucide="video" size="16"></i> Videos</div>
            <div class="sidebar-item" onclick="loadPane('{{ trash_path }}')"><i data-lucide="trash-2" size="16"></i> Trash</div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-title">System</div>
            <div class="sidebar-item" onclick="loadPane('/')"><i data-lucide="hard-drive" size="16"></i> {{ device_name }}</div>
        </div>
        
        <div class="disk-usage">
            <div class="sidebar-title">Storage</div>
            <div class="progress-bg"><div id="disk-progress" class="progress-fill"></div></div>
            <div id="disk-text" style="margin-top:8px;"></div>
        </div>

        <div class="sidebar-section" style="margin-top: auto;">
            <div class="sidebar-item" onclick="toggleTheme()"><i data-lucide="sun" id="theme-icon" size="16"></i> Appearance</div>
            <div class="sidebar-item" onclick="location.href='/logout'"><i data-lucide="log-out" size="16"></i> Logout</div>
        </div>
    </div>

    <div class="explorer">
        <div class="top-bar">
            <div style="display: flex; gap: 24px; color: var(--dim);">
                <i data-lucide="chevron-left" size="20" style="cursor:pointer;" onclick="window.history.back()"></i>
                <i data-lucide="chevron-right" size="20" style="cursor:pointer;" onclick="window.history.forward()"></i>
            </div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <select id="sort-select" class="select-input" onchange="loadPane()">
                    <option value="name">Name</option>
                    <option value="date">Date Modified</option>
                    <option value="size">Size</option>
                </select>
                <select id="filter-select" class="select-input" onchange="loadPane()">
                    <option value="all">All Files</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                    <option value="archive">Archives</option>
                    <option value="code">Code Files</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="btn-toggle" id="hiddenToggle" onclick="toggleHidden()"><i data-lucide="eye-off" id="hidden-icon" size="14"></i> Hidden</div>
                <div class="btn-toggle active" id="viewToggle" onclick="toggleViewMode()"><i data-lucide="layout-grid" id="view-icon" size="14"></i> <span id="view-text">Grid</span></div>
                <i data-lucide="search" size="18" style="color: var(--dim); cursor:pointer;"></i>
            </div>
        </div>
        <div class="breadcrumb-bar" id="bc-0"></div>
        <div class="pane-body body-grid" id="body-0"></div>
        <div class="action-bar">
            <div class="tool-btn" onclick="showPrompt('folder')"><i data-lucide="folder-plus" size="16"></i> Folder</div>
            <div class="tool-btn" onclick="showPrompt('file')"><i data-lucide="file-plus" size="16"></i> File</div>
            <div class="tool-btn" onclick="document.getElementById('file-upload').click()"><i data-lucide="upload" size="16"></i> Upload</div>
            <div id="paste-btn" class="tool-btn" style="display: none;" onclick="pasteItem()"><i data-lucide="clipboard" size="16"></i> Paste</div>
            <div id="empty-trash-btn" class="tool-btn" style="display:none;" onclick="emptyTrash()"><i data-lucide="trash" size="16"></i> Empty Trash</div>
        </div>
    </div>

    <div id="batch-bar" class="batch-bar">
        <span id="batch-count" style="font-weight: 800; border-right: 1px solid #444; padding-right: 15px;">0 Selected</span>
        <div class="batch-btn" onclick="batchAction('copy')"><i data-lucide="copy" size="16"></i> Copy</div>
        <div class="batch-btn" onclick="batchAction('move')"><i data-lucide="move" size="16"></i> Move</div>
        <div class="batch-btn" onclick="batchDelete()" style="color: #FF5F57;"><i data-lucide="trash-2" size="16"></i> Delete</div>
        <div class="batch-btn" onclick="clearSelection()"><i data-lucide="x" size="16"></i></div>
    </div>

    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" style="display:none">
        <input type="hidden" name="path" id="upload-path">
        <input type="file" name="file" id="file-upload" onchange="handleUpload()">
    </form>
    
    <div id="overlay" class="overlay" onclick="if(event.target==this) this.style.display='none'">
        <div class="overlay-content">
            <div id="overlay-body" style="flex:1; display:flex; align-items:center; justify-content:center; overflow:auto;"></div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentPath = "{{ home_path }}";
        const TRASH_PATH = {{ trash_path_raw | tojson }};
        let viewMode = 'grid';
        let showHidden = false;
        let clipboard = { action: null, path: null, names: null, name: null, is_dir: false };
        let selectedItems = new Set();
        let lastSelectedIndex = -1;

        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'moon' : 'sun');
            lucide.createIcons();
        }

        function toggleViewMode() {
            viewMode = viewMode === 'list' ? 'grid' : 'list';
            document.getElementById('view-text').innerText = viewMode.charAt(0).toUpperCase() + viewMode.slice(1);
            document.getElementById('view-icon').setAttribute('data-lucide', viewMode === 'list' ? 'layout-grid' : 'list');
            document.getElementById('viewToggle').classList.toggle('active', viewMode === 'grid');
            loadPane();
        }

        function toggleHidden() {
            showHidden = !showHidden;
            const btn = document.getElementById('hiddenToggle');
            const icon = document.getElementById('hidden-icon');
            btn.classList.toggle('active', showHidden);
            icon.setAttribute('data-lucide', showHidden ? 'eye' : 'eye-off');
            lucide.createIcons();
            loadPane();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        async function loadPane(path) {
            if (!path) path = currentPath;
            const sortBy = document.getElementById('sort-select').value;
            const filterBy = document.getElementById('filter-select').value;
            
            try {
                const resp = await fetch(`/api/list?path=${encodeURIComponent(path)}&show_hidden=${showHidden}`);
                const data = await resp.json();
                currentPath = data.path;
                const emptyTrashBtn = document.getElementById('empty-trash-btn');
                if (emptyTrashBtn) {
                    emptyTrashBtn.style.display = currentPath === TRASH_PATH ? 'flex' : 'none';
                }

                // Update Disk Info
                if (data.disk_info) {
                    document.getElementById('disk-progress').style.width = data.disk_info.percent + '%';
                    document.getElementById('disk-text').innerText = `${data.disk_info.free} free of ${data.disk_info.total}`;
                }

                // Build breadcrumbs
                document.getElementById('bc-0').innerHTML = data.breadcrumbs.map(b => 
                    `<span onclick="loadPane('${b.path.replace(/\\/g, '\\\\')}')">${b.name}</span>`
                ).join(' <i data-lucide="chevron-right" size="10" style="opacity:0.3"></i> ');

                // Combine folders and files
                const isTrashView = currentPath === TRASH_PATH;
                let items = [...data.folders.map(f => ({...f, is_dir: true})), ...data.files.map(f => ({...f, is_dir: false}))];

                // Filtering
                if (filterBy !== 'all') {
                    items = items.filter(i => i.is_dir || i.type === filterBy);
                }

                // Sorting
                items.sort((a, b) => {
                    if (sortBy === 'name') return a.name.localeCompare(b.name);
                    if (sortBy === 'date') return new Date(b.mtime) - new Date(a.mtime);
                    if (sortBy === 'size') return (b.size_bytes || 0) - (a.size_bytes || 0);
                    return 0;
                });

                if (!isTrashView) {
                    const trashEntry = { special: 'trash', name: 'Trash', rel_path: TRASH_PATH, is_dir: true };
                    items = [trashEntry, ...items];
                }

                const body = document.getElementById(`body-0`);
                body.className = `pane-body body-${viewMode}`;
                body.innerHTML = '';

                items.forEach((item, index) => {
                    const isTrashEntry = item.special === 'trash';
                    const el = document.createElement('div');
                    if (!isTrashEntry) {
                        el.setAttribute('data-item-name', item.name);
                    }
                    
                    let cb = null;
                    if (!isTrashEntry) {
                        cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.className = 'select-checkbox';
                        cb.checked = selectedItems.has(item.name);
                        cb.onclick = (e) => handleToggleSelect(e, item.name, index, items);
                    }

                    if (viewMode === 'grid') {
                        if (isTrashEntry) {
                            el.className = 'folder-card trash-entry';
                            el.onclick = () => loadPane(item.rel_path);
                            el.innerHTML = `
                                <div class="f-tab"></div>
                                <div class="f-back"></div>
                                <div class="f-front">
                                    <div class="f-name">Trash</div>
                                    <div class="f-meta">Safe release</div>
                                </div>
                            `;
                        } else if (item.is_dir) {
                            el.className = 'folder-card' + (selectedItems.has(item.name) ? ' selected-item' : '');
                            el.onclick = () => loadPane(item.rel_path);
                            el.oncontextmenu = (e) => showContextMenu(e, 'folder', item);
                            el.innerHTML = `<div class="f-tab"></div><div class="f-back"></div><div class="f-front"><div class="f-name">${item.name}</div><div class="f-meta">${item.item_count} Items</div></div>`;
                        } else {
                            el.className = 'file-card' + (selectedItems.has(item.name) ? ' selected-item' : '');
                            el.onclick = () => previewFile(item.rel_path, item.name, item.type);
                            el.oncontextmenu = (e) => showContextMenu(e, 'file', item);
                            el.innerHTML = `<div class="fi-back"></div><div class="fi-front"><div class="fi-icon"><i data-lucide="file" size="18"></i></div><div class="f-name">${item.name}</div><div class="f-meta">${item.size}</div></div>`;
                        }
                    } else {
                        if (isTrashEntry) {
                            el.className = 'entry-list trash-entry';
                            el.onclick = () => loadPane(item.rel_path);
                            el.innerHTML = `<i data-lucide="trash-2" size="18" style="opacity:0.5; flex-shrink:0;"></i><span style="flex:1">${item.name}</span><span style="color:var(--dim); font-size:11px;">Open Trash</span>`;
                        } else {
                            el.className = 'entry-list' + (selectedItems.has(item.name) ? ' selected-item' : '');
                            el.onclick = item.is_dir ? () => loadPane(item.rel_path) : () => previewFile(item.rel_path, item.name, item.type);
                            el.oncontextmenu = (e) => showContextMenu(e, item.is_dir ? 'folder' : 'file', item);
                            if (item.is_dir) {
                                el.innerHTML = `<div class="mini-f"><div class="mini-f-front"></div></div><span style="flex:1">${item.name}</span><span style="color:var(--dim); font-size:11px">${item.mtime}</span>`;
                            } else {
                                el.innerHTML = `<i data-lucide="file" size="18" style="opacity:0.5; flex-shrink:0;"></i><span style="flex:1">${item.name}</span><span style="color:var(--dim); font-size:11px; margin-right: 12px;">${item.size}</span><span style="color:var(--dim); font-size:11px">${item.mtime}</span>`;
                            }
                        }
                    }
                    if (cb) el.appendChild(cb);
                    body.appendChild(el);
                });
                lucide.createIcons();
                updateSelectionUI();
            } catch (e) {
                console.error("Failed to load pane:", e);
            }
        }

        function handleToggleSelect(e, name, index, items) {
            e.stopPropagation();
            if (e.shiftKey && lastSelectedIndex !== -1) {
                const start = Math.min(lastSelectedIndex, index);
                const end = Math.max(lastSelectedIndex, index);
                for (let i = start; i <= end; i++) {
                    const entry = items[i];
                    if (entry.special) continue;
                    selectedItems.add(entry.name);
                }
            } else {
                if (selectedItems.has(name)) {
                    selectedItems.delete(name);
                } else {
                    selectedItems.add(name);
                }
                lastSelectedIndex = index;
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const bar = document.getElementById('batch-bar');
            const countLabel = document.getElementById('batch-count');
            
            countLabel.innerText = `${selectedItems.size} Selected`;
            bar.style.display = selectedItems.size > 0 ? 'flex' : 'none';

            document.querySelectorAll('[data-item-name]').forEach(el => {
                const name = el.getAttribute('data-item-name');
                const isSelected = selectedItems.has(name);
                el.classList.toggle('selected-item', isSelected);
                const cb = el.querySelector('.select-checkbox');
                if (cb) cb.checked = isSelected;
            });
        }

        function clearSelection() {
            selectedItems.clear();
            lastSelectedIndex = -1;
            updateSelectionUI();
        }

        async function batchAction(action) {
            if (selectedItems.size === 0) return;
            clipboard = { 
                action, 
                path: currentPath, 
                names: Array.from(selectedItems).join(','),
                name: null,
                count: selectedItems.size 
            };
            document.getElementById('paste-btn').style.display = 'flex';
            clearSelection();
        }

        async function batchDelete() {
            if (selectedItems.size === 0) return;
            if (!confirm(`Are you sure you want to delete ${selectedItems.size} items?`)) return;
            
            const formData = new FormData();
            formData.append('path', currentPath);
            formData.append('item_names', Array.from(selectedItems).join(','));

            try {
                const resp = await fetch('/api/batch-delete', { method: 'POST', body: formData });
                if (resp.ok) {
                    clearSelection();
                    loadPane();
                } else {
                    alert("Batch delete failed.");
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function emptyTrash() {
            if (!confirm("Empty Trash permanently?")) return;
            try {
                const resp = await fetch('/trash/empty', { method: 'POST' });
                if (resp.ok) {
                    loadPane(TRASH_PATH);
                } else {
                    alert("Empty trash failed.");
                }
            } catch (e) {
                console.error(e);
                alert("Request error.");
            }
        }

        async function previewFile(path, name, type) {
            const overlay = document.getElementById('overlay');
            const body = document.getElementById('overlay-body');
            overlay.style.display = 'flex';
            body.innerHTML = 'Loading...';
            if (type === 'image') {
                body.innerHTML = `<img src="/preview/${encodeURIComponent(path)}" style="max-width:90%; max-height:90%; object-fit:contain; border-radius:24px;">`;
            } else if (type === 'video') {
                body.innerHTML = `<video controls autoplay style="max-width:90%; max-height:90%; border-radius:24px;"><source src="/preview/${encodeURIComponent(path)}" type="video/mp4">Your browser does not support the video tag.</video>`;
            } else {
                try {
                    const resp = await fetch(`/preview/${encodeURIComponent(path)}`);
                    const text = await resp.text();
                    body.innerHTML = `<textarea style="width:100%; height:100%; border:none; padding:64px; font-family:'SF Mono', monospace; font-size:13px; outline:none; background:transparent; color:inherit; resize:none; line-height:1.6;" readonly>${text}</textarea>`;
                } catch (e) {
                    body.innerHTML = "Error loading preview.";
                }
            }
        }

        function showContextMenu(e, type, data) {
            e.preventDefault();
            e.stopPropagation();
            ctxTarget = data;
            
            const ctxMenu = document.getElementById('context-menu');
            let menuHtml = '';
            const pathEscaped = data ? data.rel_path.replace(/\\/g, '\\\\') : '';

            if (type === 'folder') {
                menuHtml = `
                    <div class="context-menu-item" onclick="loadPane('${pathEscaped}')"><i data-lucide="folder-open" size="16"></i> Open</div>
                    <div class="context-menu-item" onclick="setClipboard('copy', '${pathEscaped}', '${data.name}', true)"><i data-lucide="copy" size="16"></i> Copy</div>
                    <div class="context-menu-item" onclick="setClipboard('move', '${pathEscaped}', '${data.name}', true)"><i data-lucide="move" size="16"></i> Move</div>
                    <div class="context-menu-item" onclick="zipItem('${pathEscaped}', '${data.name}')"><i data-lucide="file-archive" size="16"></i> Zip</div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="renameItem('${data.name}')"><i data-lucide="edit-3" size="16"></i> Rename</div>
                    <div class="context-menu-item" onclick="deleteItem('${pathEscaped}')" style="color: #ff5f57;"><i data-lucide="trash-2" size="16"></i> Delete</div>
                `;
            } else if (type === 'file') {
                const isZip = ['zip', 'rar', 'tar', 'gz'].includes(data.ext);
                menuHtml = `
                    <div class="context-menu-item" onclick="previewFile('${pathEscaped}', '${data.name}', '${data.type}')"><i data-lucide="eye" size="16"></i> Preview</div>
                    <div class="context-menu-item" onclick="location.href='/download/${encodeURIComponent(data.rel_path)}'"><i data-lucide="download" size="16"></i> Download</div>
                    <div class="context-menu-item" onclick="setClipboard('copy', '${pathEscaped}', '${data.name}', false)"><i data-lucide="copy" size="16"></i> Copy</div>
                    <div class="context-menu-item" onclick="setClipboard('move', '${pathEscaped}', '${data.name}', false)"><i data-lucide="move" size="16"></i> Move</div>
                    ${isZip ? `<div class="context-menu-item" onclick="unzipItem('${pathEscaped}', '${data.name}')"><i data-lucide="package-open" size="16"></i> Unzip</div>` : `<div class="context-menu-item" onclick="zipItem('${pathEscaped}', '${data.name}')"><i data-lucide="file-archive" size="16"></i> Zip</div>`}
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="renameItem('${data.name}')"><i data-lucide="edit-3" size="16"></i> Rename</div>
                    <div class="context-menu-item" onclick="deleteItem('${pathEscaped}')" style="color: #ff5f57;"><i data-lucide="trash-2" size="16"></i> Delete</div>
                `;
            } else {
                menuHtml = `
                    <div class="context-menu-item" onclick="loadPane()"><i data-lucide="refresh-cw" size="16"></i> Refresh</div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="showPrompt('folder')"><i data-lucide="folder-plus" size="16"></i> New Folder</div>
                    <div class="context-menu-item" onclick="showPrompt('file')"><i data-lucide="file-plus" size="16"></i> New File</div>
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item" onclick="document.getElementById('file-upload').click()"><i data-lucide="upload" size="16"></i> Upload</div>
                    ${clipboard.action ? `<div class="context-menu-item" onclick="pasteItem()"><i data-lucide="clipboard" size="16"></i> Paste ${clipboard.names || clipboard.name}</div>` : ''}
                `;
            }

            ctxMenu.innerHTML = menuHtml;
            lucide.createIcons();
            ctxMenu.style.display = 'block';
            ctxMenu.style.left = `${e.clientX}px`;
            ctxMenu.style.top = `${e.clientY}px`;
        }

        function setClipboard(action, path, name, isDir) {
            clipboard = { action, path, name, names: null, is_dir: isDir };
            document.getElementById('paste-btn').style.display = 'flex';
        }

        async function pasteItem() {
            if (!clipboard.action) return;
            
            const formData = new FormData();
            formData.append('dest_path', currentPath);
            
            let endpoint = '';
            if (clipboard.names) {
                formData.append('path', clipboard.path);
                formData.append('item_names', clipboard.names);
                endpoint = clipboard.action === 'copy' ? '/api/batch-copy' : '/api/batch-move';
            } else {
                formData.append('item_name', clipboard.name);
                const pathParts = clipboard.path.split(/[\\/]/);
                pathParts.pop();
                formData.append('path', pathParts.join('/') || '/');
                endpoint = clipboard.action === 'copy' ? '/copy' : '/move';
            }

            try {
                const resp = await fetch(endpoint, { method: 'POST', body: formData });
                if (resp.ok) {
                    if (clipboard.action === 'move') {
                        clipboard = { action: null, path: null, names: null, name: null, is_dir: false };
                        document.getElementById('paste-btn').style.display = 'none';
                    }
                    loadPane();
                } else {
                    const err = await resp.json();
                    alert("Paste failed: " + (err.detail || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                alert("Request error.");
            }
        }

        async function zipItem(path, name) {
            const formData = new FormData();
            const parts = path.split(/[\\/]/);
            parts.pop();
            formData.append('path', parts.join('/') || '/');
            formData.append('item_name', name);
            try {
                const resp = await fetch('/zip', { method: 'POST', body: formData });
                if (resp.ok) loadPane();
                else alert("Zip failed.");
            } catch (e) { console.error(e); }
        }

        async function unzipItem(path, name) {
            const formData = new FormData();
            const parts = path.split(/[\\/]/);
            parts.pop();
            formData.append('path', parts.join('/') || '/');
            formData.append('item_name', name);
            try {
                const resp = await fetch('/unzip', { method: 'POST', body: formData });
                if (resp.ok) loadPane();
                else alert("Unzip failed.");
            } catch (e) { console.error(e); }
        }

        async function deleteItem(path) {
            if (confirm(`Are you sure you want to delete this?`)) {
                const cleanPath = path.startsWith('/') ? path.substring(1) : path;
                try {
                    const resp = await fetch(`/delete/${encodeURIComponent(cleanPath)}`);
                    if (resp.ok) {
                        loadPane();
                    } else {
                        alert("Delete failed.");
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }

        function renameItem(oldName) {
            const newName = prompt('Enter new name:', oldName);
            if (newName && newName !== oldName) {
                const formData = new FormData();
                formData.append('path', currentPath);
                formData.append('old_name', oldName);
                formData.append('new_name', newName);
                
                fetch('/rename', { method: 'POST', body: formData })
                    .then(() => loadPane());
            }
        }

        async function showPrompt(type) {
            const label = type === 'folder' ? 'folder' : 'file';
            const name = prompt(`Enter ${label} name:`);
            if (!name) return;

            const endpoint = type === 'folder' ? '/create-folder' : '/create-file';
            const formData = new FormData();
            formData.append('path', currentPath);
            formData.append('name', name);

            try {
                const resp = await fetch(endpoint, { method: 'POST', body: formData });
                if (resp.ok) {
                    loadPane();
                } else {
                    alert(`Create ${label} failed.`);
                }
            } catch (e) {
                console.error(e);
                alert("Request error.");
            }
        }

        function handleUpload() { 
            const path = currentPath;
            const fileInput = document.getElementById('file-upload');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            fetch(`/upload?path=${encodeURIComponent(path)}`, {
                method: 'POST',
                body: formData
            }).then(() => loadPane());
        }

        document.getElementById('body-0').addEventListener('contextmenu', (e) => {
            if (e.target === document.getElementById('body-0')) {
                showContextMenu(e, 'bg');
            }
        });

        document.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        loadPane();
    </script>
</body>
</html>
